const express = require("express");
const router = express.Router();
const Store = require("../models/Store");
const Rating = require("../models/Rating");
const User = require("../models/User");

// GET /api/stores?search=...&page=1
router.get("/", async (req,res) => {
  try {
    const { search } = req.query;
    const where = {};
    if(search) {
      where[Op.or] = [
        { name: { [Op.like]: `%${search}%` } },
        { address: { [Op.like]: `%${search}%` } }
      ];
    }
    const stores = await Store.findAll({
      include: [
        { model: Rating, attributes: [] },
      ],
      attributes: {
        include: [
          // average rating - raw SQL via sequelize.fn
          [sequelize.fn("AVG", sequelize.col("ratings.rating")), "avgRating"]
        ]
      },
      group: ["Store.id"]
    });
    res.json(stores);
  } catch(err) {
    console.error(err); res.status(500).send("Server error");
  }
});

// Admin: add store
router.post("/", async (req,res) => {
  try {
    const { name, email, address, ownerId } = req.body;
    const store = await Store.create({ name, email, address, ownerId });
    res.json(store);
  } catch(err) {
    console.error(err); res.status(500).send("Server error");
  }
});

module.exports = router;
